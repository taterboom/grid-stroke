import e,{useRef as t,useState as r,useEffect as n,useMemo as a,useCallback as l}from"react";import{Upload as o,Select as i,Button as c,Modal as u,Row as s,Col as f}from"antd";import{ChromePicker as m}from"react-color";var v=function(e){if(Array.isArray(e))return e};var d=function(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var r=[],n=!0,a=!1,l=void 0;try{for(var o,i=e[Symbol.iterator]();!(n=(o=i.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(e){a=!0,l=e}finally{try{n||null==i.return||i.return()}finally{if(a)throw l}}return r}};var h=function(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n};var g=function(e,t){if(e){if("string"==typeof e)return h(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?h(e,t):void 0}};var p=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")};var E,b=function(e,t){return v(e)||d(e,t)||g(e,t)||p()};function T(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=e.r,n=e.g,a=e.b,l=e.a;return 255===t&&(l*=255),[r,n,a,l]}function y(e,t,r,n,a,l,o){var i=b(t,4),c=i[0],u=i[1],s=i[2],f=i[3],m=b(r,4),v=m[0],d=m[1],h=m[2],g=m[3],p=T(n,255);if(c)for(var y=0;y<(u&&v?a+o:a);y++)w.call(this,E.TOP,e+4*y,p,l,o);if(u)for(var O=0;O<(s&&d?a+o:a);O++)w.call(this,E.RIGHT,e+4*l*O+4*a,p,l,o);if(s)for(var k=0;k<(f&&h?a+o:a);k++)w.call(this,E.BOTTOM,e+4*a*l+4*(a-k),p,l,o);if(f)for(var L=0;L<(c&&g?a+o:a);L++)w.call(this,E.LEFT,e+4*(a-L)*l,p,l,o)}function w(e,t,r,n,a){for(var l=0;l<a;l++)switch(e){case E.TOP:O.call(this,t-4*n*l,r);break;case E.RIGHT:O.call(this,t+4*l,r);break;case E.BOTTOM:O.call(this,t+4*n*l,r);break;case E.LEFT:O.call(this,t-4*l,r)}}function O(e,t){for(var r=0;r<t.length;r++)this[e+r]=t[r]}!function(e){e[e.TOP=0]="TOP",e[e.RIGHT=1]="RIGHT",e[e.BOTTOM=2]="BOTTOM",e[e.LEFT=3]="LEFT"}(E||(E={}));var k=function(t){var r=t.label,n=t.children;return e.createElement(s,{gutter:[0,20]},e.createElement(f,{span:6},r,":"),e.createElement(f,{span:18},n))},L=e.forwardRef((function(l,o){var i=l.canvasSize,c=l.imgUrl,u=t(null),s=r((function(){return{width:0,height:0}})),f=b(s,2),m=f[0],v=f[1],d=r((function(){return{left:0,top:0}})),h=b(d,2),g=h[0],p=h[1];n((function(){var e=u.current,t=function(){e&&v({width:e.offsetWidth||0,height:e.offsetHeight||0})},r=function(){e&&p({left:e.scrollLeft||0,top:e.scrollTop||0})};return t(),document.addEventListener("resize",t),e&&e.addEventListener("scroll",r),function(){document.removeEventListener("resize",t),e&&e.removeEventListener("scroll",r)}}),[]);var E=a((function(){var e=200*m.width/i,t=200/i;return{width:e,height:e,left:g.left*t,top:g.top*t}}),[m,g,i]);return e.createElement("div",{className:"grid-stroke__canvas-contianer"},e.createElement("div",{ref:u,className:"grid-stroke__canvas"},e.createElement("canvas",{ref:o,width:i,height:i})),e.createElement("div",{className:"grid-stroke__map-container"},e.createElement("p",null,"Map："),e.createElement("div",{className:"grid-stroke__map",style:{width:200,height:200}},e.createElement("img",{src:c,alt:""}),e.createElement("div",{className:"grid-stroke__map-handler",style:E}))))}));export default function(){var a=r(!1),s=b(a,2),f=s[0],v=s[1],d=r(""),h=b(d,2),g=h[0],p=h[1],E=r(2016),w=b(E,2),O=w[0],_=w[1],I=r(""),R=b(I,2),P=R[0],U=R[1],S=r(16),N=b(S,2),A=N[0],C=N[1],x=r({r:0,g:0,b:0,a:1}),D=b(x,2),M=D[0],j=D[1],F=r(1),H=b(F,2),z=H[0],B=(H[1],r({r:0,g:0,b:0,a:1})),G=b(B,2),V=G[0],W=G[1],$=t(null),q=l((function(e){var t;return(t=e,new Promise((function(e,r){var n=new FileReader;n.addEventListener("load",(function(){return e(n.result+"")})),n.readAsDataURL(t)}))).then(U),!1}),[]);n((function(){var e;P&&(e=P,new Promise((function(t,r){var n=new Image;n.onload=function(){t(n)},n.src=e}))).then((function(e){if(console.log(e),null!==$.current){var t=$.current,r=t.width,n=t.height,a=$.current.getContext("2d");if(null===a)return;a.clearRect(0,0,r,n),a.drawImage(e,0,0);var l=T(M),o="rgba(".concat(l.join(", "),")");console.log(o),a.strokeStyle=o;for(var i=A;i<r;i+=A)a.beginPath(),a.moveTo(0,i+.5),a.lineTo(r,i+.5),a.closePath(),a.stroke(),a.beginPath(),a.moveTo(i+.5,0),a.lineTo(i+.5,n),a.closePath(),a.stroke();for(var c=a.getImageData(0,0,r,n),u=c.data,s=r%A*4||4*A,f=4*r-s,m=4*A;m<u.length;)m<4*r||parseInt(m/(4*r)+"")%A>0?(0===u[m-4+3]&&0===u[m+4+3]&&(u[m+3]=0),m+=m%(4*r)===f?s:4*A):((m%A==0&&0===u[m-4*r+3]&&0===u[m-4+3]&&0===u[m+4*(r+1)+3]||0===u[m-4*r+3]&&0===u[m+4*r+3])&&(u[m+3]=0),m+=4);for(var v=4*A;v<u.length;){if(0!==u[v+4*(r*A/2+A/2)+3]){var d=u[v-4*(r-A/2)+3],h=u[v-4*(r-A)+3],g=u[v+4*(A/2*r+A+1)+3],E=u[v+4*(A*r+A+1)+3],b=u[v+4*((A+1)*r+A/2)+3],w=u[v+(A+1)*r*4+3],O=u[v+4*(A/2*r-1)+3],k=u[v+4*(r-1)+3],L=[d,g,b,O].map((function(e){return 0===e||void 0===e})),_=[h,E,w,k].map((function(e){return 0===e||void 0===e}));y.call(u,v,L,_,V,A,r,z)}v+=v%(4*r)===f?s+4*(A-1)*r:4*A}a.putImageData(c,0,0),p($.current.toDataURL("image/png"))}}))}),[P,A,O,M,z,V]);l((function(e){C(e)}),[]);var J=l((function(e){j(e.rgb)}),[]),K=(l((function(e){W(e.rgb)}),[]),l((function(e){_(e)}),[])),Q=l((function(){if(null!==$.current){var e=document.createElement("a");e.href=$.current.toDataURL("image/png"),e.download="test.png",e.click()}}),[]),X=l((function(){null!==$.current&&(p($.current.toDataURL("image/png")),v(!0))}),[]),Y=l((function(){v(!1)}),[]);return e.createElement("div",{className:"grid-stroke__container"},e.createElement(L,{ref:$,canvasSize:O,imgUrl:g}),e.createElement("div",{className:"grid-stroke__attr"},e.createElement(k,{label:"图片"},e.createElement(o,{listType:"picture-card",showUploadList:!1,beforeUpload:q},P?e.createElement("img",{src:P,style:{width:"100%"},alt:"pic"}):e.createElement("div",null,e.createElement("div",{className:"ant-upload-text"},"Upload")))),e.createElement(k,{label:"图片大小"},e.createElement(i,{defaultValue:2016,style:{width:80},onChange:K},e.createElement(i.Option,{value:504},"504"),e.createElement(i.Option,{value:1008},"1008"),e.createElement(i.Option,{value:2016},"2016"))),e.createElement(k,{label:"网格颜色"},e.createElement(m,{color:M,onChange:J})),e.createElement(c,{onClick:Q},"导出"),e.createElement(c,{onClick:X},"弹出图片手动保存"),e.createElement(u,{title:"长按或右击保存",visible:f,onOk:Y,onCancel:Y},e.createElement("div",{style:{width:"400px",height:"400px",overflow:"scroll",margin:"0 auto"}},e.createElement("img",{src:g,alt:""})))))}
